# verilib-structure

Verilib structure files for outlining verification goals

## Installation

### Prerequisites

1. Install proof tools: Verus, Verus Analyzer, SCIP.
   ```
   git clone https://github.com/Beneficial-AI-Foundation/installers_for_various_tools
   cd installers_for_various_tools
   python3 verus_installer_from_release.py --version "0.2025.08.25.63ab0cb"
   python3 verus_analyzer_installer.py
   python3 scip_installer.py
   ```

2. Install atomization and verification tool.
   ```
   git clone https://github.com/Beneficial-AI-Foundation/probe-verus
   cd probe-verus
   cargo install --path .
   ```

### Install verilib-structure

**From source:**

```bash
git clone git@github.com:Beneficial-AI-Foundation/verilib-structure.git
cd verilib-structure
cargo install --path .
```

This installs the `verilib-structure` binary to `~/.cargo/bin/`.

**Development build:**

```bash
cargo build --release
# Binary available at ./target/release/verilib-structure
```

## Usage

```bash
verilib-structure <command> [options]
```

| Command | Description |
|---------|-------------|
| `create` | Initialize structure files from source analysis |
| `atomize` | Enrich structure files with metadata |
| `specify` | Check specification status and manage spec certs |
| `verify` | Run verification and manage verification certs |

## create

Generates `.md` structure files from source analysis. Analyzes Verus/Rust code via `analyze_verus_specs_proofs.py`. Generate supporting `config.json` and `.gitignore` files.

**Usage:**

```bash
verilib-structure create [PROJECT_ROOT] [--root <root>]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Options:**

| Option | Description |
|--------|-------------|
| `--root` | Root directory for structure files (default: `.verilib/structure`) |

**Examples:**

```bash
# Generate .md file hierarchy (current directory)
verilib-structure create

# Generate .md file hierarchy for a specific project
verilib-structure create /path/to/project
```

**Generated `config.json` file:**

Creates `<project_root>/.verilib/config.json` with:
```json
{
  "structure-root": ".verilib/structure"
}
```

**Generated `.gitignore` file:**

Creates `<project_root>/.verilib/.gitignore` to exclude generated files:
```
# Generated by VeriLib (not tracked)
atoms.json
specs.json
stubs.json
proofs.json
```

**Generated `.md` file:**

```yaml
---
code-path: path/to/source/file.rs
code-line: 42
code-name: null
---
```

## atomize

Generate `stubs.json` file with the molecular structure and enrich it with atom metadata. Optionally, the `.md` stub files can be updated with the stable `code-name` replacing the brittle `code-path` and `code-line` fields.

Runs `probe-verus stubify` to generate `stubs.json` and `probe-verus atomize` to generate atom metadata.

**Note:** Requires `config.json` created by `create` to get `structure-root`.

**Usage:**

```bash
verilib-structure atomize [PROJECT_ROOT] [--update-stubs]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Options:**

| Option | Description |
|--------|-------------|
| `-s`, `--update-stubs` | Update .md structure files with code-name from atoms |

**Output:**

Generates `<project_root>/.verilib/stubs.json` with enriched metadata. 

**Examples:**

```bash
# Generate enriched stubs.json (current directory)
verilib-structure atomize

# Also update .md files with code-name
verilib-structure atomize --update-stubs

# Process a specific project
verilib-structure atomize /path/to/project
```

**Enriched stubs.json format:**

```json
{
  "path/to/function_name.md": {
    "code-path": "curve25519-dalek/src/montgomery.rs",
    "code-lines": { "start": 42, "end": 50 },
    "code-name": "probe:curve25519-dalek/4.1.3/montgomery/MontgomeryPoint#ct_eq()",
    "code-module": "montgomery",
    "dependencies": ["probe:dep1", "probe:dep2"],
    "display-name": "ct_eq"
  }
}
```

## specify

Checks specification status and manages specification certs. Runs `probe-verus specify` to identify functions with `requires`/`ensures` specs.

**Usage:**

```bash
verilib-structure specify [PROJECT_ROOT]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Workflow:**

1. Identifies functions with specs (requires/ensures)
2. Compares with existing certs in `.verilib/certs/specify/`
3. Displays a multiple choice menu of uncertified functions
4. Creates cert files for user-selected functions

**Cert files:**

Certs are stored in `.verilib/certs/specify/` with one JSON file per certified function:
- Filename: URL-encoded code-name + `.json`
- Content: `{"timestamp": "<ISO 8601 timestamp>"}`

**Examples:**

```bash
# Check and certify specs (current directory)
verilib-structure specify

# Check and certify specs for a specific project
verilib-structure specify /path/to/project
```

**Interactive selection:**

When prompted, you can enter:
- Individual numbers: `1, 3, 5`
- Ranges: `1-5`
- `all` to select all uncertified functions
- `none` or empty to skip

## verify

Runs verification and automatically manages verification certs. Runs `probe-verus verify` to check proof status.

**Usage:**

```bash
verilib-structure verify [PROJECT_ROOT] [--verify-only-module <module>]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Options:**

| Option | Description |
|--------|-------------|
| `--verify-only-module` | Only verify functions in this module |

**Workflow:**

1. Runs probe-verus verify to check verification status
2. Filters to only functions in the structure
3. Compares with existing certs in `.verilib/certs/verify/`
4. Creates new certs for verified functions without certs
5. Deletes certs for failed functions with existing certs
6. Shows summary of all changes

**Cert files:**

Certs are stored in `.verilib/certs/verify/` with one JSON file per verified function:
- Filename: URL-encoded code-name + `.json`
- Content: `{"timestamp": "<ISO 8601 timestamp>"}`

**Examples:**

```bash
# Run verification and update certs (current directory)
verilib-structure verify

# Run verification for a specific project
verilib-structure verify /path/to/project

# Run verification for only the edwards module
verilib-structure verify --verify-only-module edwards
```

**Output:**

The command shows a summary of changes:
```
============================================================
VERIFICATION CERT CHANGES
============================================================

✓ Created 5 new certs:
  + func_name
    probe:crate/version/module#func()

✗ Deleted 2 certs (verification failed):
  - other_func
    probe:crate/version/module#other_func()

============================================================
Total certs: 10 → 13
  Created: +5
  Deleted: -2
============================================================
```

## Case Study: Dalek-Lite

1. Create structure files
   ```
   git clone git@github.com:Beneficial-AI-Foundation/dalek-lite.git
   cd dalek-lite
   git checkout -b sl/structure
   verilib-structure create
   ```

2. Run atomization checks
   ```
   verilib-structure atomize
   ```

3. Run specification checks
   ```
   verilib-structure specify
   ```

4. Run verification checks
   ```
   verilib-structure verify
   ```

## Building from Source

**Requirements:**
- Rust 1.70 or later

**Build commands:**

```bash
# Debug build
cargo build

# Release build (optimized)
cargo build --release

# Install to ~/.cargo/bin
cargo install --path .

# Run tests
cargo test

# Run with cargo (without installing)
cargo run -- --help
cargo run -- create
```

## License

MIT
