# verilib-structure (DEPRECATED)

> **Deprecated:** This repository has been merged with [verilib-cli](https://github.com/Beneficial-AI-Foundation/verilib-cli) and is no longer maintained.

Verilib structure files for outlining verification goals

## Installation

### Prerequisites

1. Install proof tools: Verus, Verus Analyzer, SCIP.
   ```
   git clone https://github.com/Beneficial-AI-Foundation/installers_for_various_tools
   cd installers_for_various_tools
   python3 verus_installer_from_release.py --version "0.2025.08.25.63ab0cb"
   python3 verus_analyzer_installer.py
   python3 scip_installer.py
   ```

2. Install atomization and verification tool.
   ```
   git clone https://github.com/Beneficial-AI-Foundation/probe-verus
   cd probe-verus
   cargo install --path .
   ```

### Install verilib-structure

**From source:**

```bash
git clone git@github.com:Beneficial-AI-Foundation/verilib-structure.git
cd verilib-structure
cargo install --path .
```

This installs the `verilib-structure` binary to `~/.cargo/bin/`.

**Development build:**

```bash
cargo build --release
# Binary available at ./target/release/verilib-structure
```

## Usage

```bash
verilib-structure <command> [options]
```

| Command | Description |
|---------|-------------|
| `create` | Initialize structure files from source analysis |
| `atomize` | Enrich structure files with metadata |
| `specify` | Check specification status and manage spec certs |
| `verify` | Run verification and update stubs.json with status |

## create

Generates `.md` structure files from source analysis. Analyzes Verus/Rust code via `analyze_verus_specs_proofs.py`. Generate supporting `config.json` and `.gitignore` files.

**Usage:**

```bash
verilib-structure create [PROJECT_ROOT] [--root <root>]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Options:**

| Option | Description |
|--------|-------------|
| `--root` | Root directory for structure files (default: `.verilib/structure`) |

**Examples:**

```bash
# Generate .md file hierarchy (current directory)
verilib-structure create

# Generate .md file hierarchy for a specific project
verilib-structure create /path/to/project
```

**Generated `config.json` file:**

Creates `<project_root>/.verilib/config.json` with:
```json
{
  "structure-root": ".verilib/structure"
}
```

**Generated `.gitignore` file:**

Creates `<project_root>/.verilib/.gitignore` to exclude generated files:
```
# Generated by VeriLib (not tracked)
atoms.json
specs.json
stubs.json
proofs.json
```

**Generated `.md` file:**

```yaml
---
code-path: path/to/source/file.rs
code-line: 42
code-name: null
---
```

## atomize

Generate `stubs.json` file with the molecular structure and enrich it with atom metadata. Optionally, the `.md` stub files can be updated with the stable `code-name` replacing the brittle `code-path` and `code-line` fields.

**Workflow:**

1. Runs `probe-verus stubify` to generate initial `stubs.json` from `.md` files
2. Runs `probe-verus atomize` to generate `atoms.json` with full atom metadata
3. For each entry in `stubs.json`:
   - Computes `code-name` from `code-path` and `code-line`
   - Appends all metadata from `atoms.json` for this `code-name`
4. Saves the enriched `stubs.json`

**Note:** Requires `config.json` created by `create` to get `structure-root`.

**Usage:**

```bash
verilib-structure atomize [PROJECT_ROOT] [--update-stubs]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Options:**

| Option | Description |
|--------|-------------|
| `-s`, `--update-stubs` | Update .md structure files with code-name from atoms |

**Output:**

Generates `<project_root>/.verilib/stubs.json` with enriched metadata. 

**Examples:**

```bash
# Generate enriched stubs.json (current directory)
verilib-structure atomize

# Also update .md files with code-name
verilib-structure atomize --update-stubs

# Process a specific project
verilib-structure atomize /path/to/project
```

**Enriched stubs.json format:**

```json
{
  "path/to/function_name.md": {
    "code-path": "curve25519-dalek/src/montgomery.rs",
    "code-text": { "lines-start": 42, "lines-end": 50 },
    "code-name": "probe:curve25519-dalek/4.1.3/montgomery/MontgomeryPoint#ct_eq()",
    "code-module": "montgomery",
    "dependencies": ["probe:dep1", "probe:dep2"],
    "display-name": "ct_eq"
  }
}
```

## specify

Checks specification status and manages specification certs. Runs `probe-verus specify` to identify functions with specifications.

**Usage:**

```bash
verilib-structure specify [PROJECT_ROOT]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Workflow:**

1. Identifies functions with specs (where `specified: true`)
2. Compares with existing certs in `.verilib/certs/specs/`
3. Displays a multiple choice menu of uncertified functions
4. Creates cert files for user-selected functions

**Cert files:**

Certs are stored in `.verilib/certs/specs/` with one JSON file per certified function:
- Filename: URL-encoded code-name + `.json`
- Content: `{"timestamp": "<ISO 8601 timestamp>"}`

**Examples:**

```bash
# Check and certify specs (current directory)
verilib-structure specify

# Check and certify specs for a specific project
verilib-structure specify /path/to/project
```

**Interactive selection:**

When prompted, you can enter:
- Individual numbers: `1, 3, 5`
- Ranges: `1-5`
- `all` to select all uncertified functions
- `none` or empty to skip

## verify

Runs verification and updates `stubs.json` with verification status. Runs `probe-verus verify` to check proof status.

**Usage:**

```bash
verilib-structure verify [PROJECT_ROOT] [--verify-only-module <module>]
```

**Arguments:**

| Argument | Description |
|----------|-------------|
| `PROJECT_ROOT` | Project root directory (default: current working directory) |

**Options:**

| Option | Description |
|--------|-------------|
| `--verify-only-module` | Only verify functions in this module |

**Workflow:**

1. Loads existing `stubs.json`
2. Runs `probe-verus verify` to generate `proofs.json`
3. For each stub with a `code-name`, looks up verification status from `proofs.json`
4. Updates `stubs.json` with `verified: true/false` for each stub
5. Shows summary of newly verified and newly unverified items

**Generated `proofs.json` schema:**

```json
{
  "probe:crate/version/module#function()": {
    "verified": true
  }
}
```

**Updated `stubs.json` schema:**

After verification, each stub entry gains a `verified` field:
```json
{
  "path/to/function_name.md": {
    "code-path": "curve25519-dalek/src/montgomery.rs",
    "code-text": { "lines-start": 42, "lines-end": 50 },
    "code-name": "probe:curve25519-dalek/4.1.3/montgomery/MontgomeryPoint#ct_eq()",
    "verified": true
  }
}
```

**Examples:**

```bash
# Run verification and update stubs.json (current directory)
verilib-structure verify

# Run verification for a specific project
verilib-structure verify /path/to/project

# Run verification for only the edwards module
verilib-structure verify --verify-only-module edwards
```

**Output:**

The command shows a summary of changes:
```
============================================================
VERIFICATION STATUS CHANGES
============================================================

✓ Newly verified (5):
  + func_name
    path/to/func.md

✗ Newly unverified (2):
  - other_func
    path/to/other_func.md

============================================================
  Newly verified: +5
  Newly unverified: -2
============================================================
```

## Case Study: Dalek-Lite

1. Create structure files
   ```
   git clone git@github.com:Beneficial-AI-Foundation/dalek-lite.git
   cd dalek-lite
   git checkout -b sl/structure

   verilib-structure create
   ```

2. Run atomization checks
   ```
   verilib-structure atomize --update-stubs
   ```

3. Run specification checks
   ```
   verilib-structure specify
   ```

4. Run verification checks
   ```
   verilib-structure verify
   ```

## Building from Source

**Requirements:**
- Rust 1.70 or later

**Build commands:**

```bash
# Debug build
cargo build

# Release build (optimized)
cargo build --release

# Install to ~/.cargo/bin
cargo install --path .

# Run tests
cargo test

# Run with cargo (without installing)
cargo run -- --help
cargo run -- create
```

## License

MIT
